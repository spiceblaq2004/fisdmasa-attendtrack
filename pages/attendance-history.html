<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance History - FISDMASA AttendTrack</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .history-container {
            padding: 100px 20px 50px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
        }
        
        .history-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            padding: 20px;
            background: var(--light);
            font-weight: bold;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .status-present {
            color: #10b981;
            font-weight: bold;
        }
        
        .status-absent {
            color: #ef4444;
            font-weight: bold;
        }
        
        .status-late {
            color: #f59e0b;
            font-weight: bold;
        }
        
        .course-badge {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .table-header, .table-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-fire-extinguisher"></i>
                <span>FISDMASA AttendTrack</span>
            </div>
            <div class="nav-links">
                <a href="student-dashboard.html">Dashboard</a>
                <a href="../index.html">Home</a>
                <a href="../index.html" class="login-btn logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <div class="history-container">
        <div class="dashboard-header">
            <div class="welcome-message">
                <h1>Attendance History</h1>
                <p>View your complete attendance record</p>
            </div>
            <div class="btn btn-primary" onclick="showNotification('Export feature coming soon!')">
                <i class="fas fa-download"></i>
                Export Report
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <div style="font-size: 2rem; color: var(--primary); font-weight: bold;" id="totalClasses">0</div>
                <div>Total Classes</div>
            </div>
            <div class="summary-card">
                <div style="font-size: 2rem; color: #10b981; font-weight: bold;" id="presentClasses">0</div>
                <div>Present</div>
            </div>
            <div class="summary-card">
                <div style="font-size: 2rem; color: #ef4444; font-weight: bold;" id="absentClasses">0</div>
                <div>Absent</div>
            </div>
            <div class="summary-card">
                <div style="font-size: 2rem; color: var(--primary); font-weight: bold;" id="attendanceRate">0%</div>
                <div>Attendance Rate</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Course:</label>
                <select id="courseFilter">
                    <option value="all">All Courses</option>
                    <option value="1">FSDM 301: Fire Dynamics</option>
                    <option value="2">FSDM 303: Disaster Management</option>
                    <option value="3">FSDM 305: Safety Engineering</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Status:</label>
                <select id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Month:</label>
                <select id="monthFilter">
                    <option value="all">All Months</option>
                    <option value="0">January 2024</option>
                    <option value="1">February 2024</option>
                    <option value="2">March 2024</option>
                    <option value="3">April 2024</option>
                </select>
            </div>
            
            <button class="btn" onclick="applyFilters()">Apply Filters</button>
            <button class="btn" onclick="resetFilters()">Reset</button>
        </div>

        <div class="history-table">
            <div class="table-header">
                <div>Course & Date</div>
                <div>Time</div>
                <div>Lecturer</div>
                <div>Status</div>
                <div>Remarks</div>
            </div>
            <div id="attendanceTableBody">
                <!-- Attendance records will be loaded here -->
            </div>
        </div>

        <div class="export-options">
            <button class="btn" onclick="showNotification('PDF export coming soon!')">
                <i class="fas fa-file-pdf"></i>
                Export as PDF
            </button>
            <button class="btn" onclick="showNotification('Excel export coming soon!')">
                <i class="fas fa-file-excel"></i>
                Export as Excel
            </button>
            <button class="btn" onclick="window.print()">
                <i class="fas fa-print"></i>
                Print Report
            </button>
        </div>
    </div>

    <script>
        // Attendance History functionality
        class AttendanceHistory {
            constructor() {
                this.token = localStorage.getItem('authToken');
                this.user = JSON.parse(localStorage.getItem('user') || '{}');
                this.records = JSON.parse(localStorage.getItem('fisdmasa_records')) || this.getDefaultRecords();
                this.init();
            }

            init() {
                if (!this.token) {
                    window.location.href = 'login.html';
                    return;
                }

                this.renderHistory();
                this.setupEventListeners();
            }

            getDefaultRecords() {
                // Generate comprehensive demo records
                const records = [];
                const courses = [
                    { id: 1, code: 'FSDM 301', name: 'Fire Dynamics', lecturer: 'Dr. A. Mensah' },
                    { id: 2, code: 'FSDM 303', name: 'Disaster Management', lecturer: 'Dr. K. Owusu' },
                    { id: 3, code: 'FSDM 305', name: 'Safety Engineering', lecturer: 'Prof. E. Asante' }
                ];

                const today = new Date();
                
                // Generate records for the past 60 days
                for (let i = 0; i < 60; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    // Only include weekdays
                    if (date.getDay() !== 0 && date.getDay() !== 6) {
                        courses.forEach(course => {
                            // Only add records for scheduled days
                            if (
                                (course.id === 1 && (date.getDay() === 1 || date.getDay() === 3)) || // Mon, Wed
                                (course.id === 2 && (date.getDay() === 2 || date.getDay() === 4)) || // Tue, Thu
                                (course.id === 3 && date.getDay() === 5) // Fri
                            ) {
                                const status = Math.random() > 0.2 ? 'present' : 'absent'; // 80% attendance rate
                                const time = course.id === 1 ? '8:00 AM' : course.id === 2 ? '10:00 AM' : '2:00 PM';
                                
                                records.push({
                                    id: records.length + 1,
                                    courseId: course.id,
                                    courseCode: course.code,
                                    courseName: course.name,
                                    lecturer: course.lecturer,
                                    date: new Date(date),
                                    time: time,
                                    status: status,
                                    remarks: status === 'present' ? 'On time' : 'No reason provided'
                                });
                            }
                        });
                    }
                }

                return records.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            renderHistory(filteredRecords = null) {
                const records = filteredRecords || this.records;
                const tableBody = document.getElementById('attendanceTableBody');
                
                tableBody.innerHTML = '';

                if (records.length === 0) {
                    tableBody.innerHTML = `
                        <div class="table-row" style="text-align: center; color: var(--gray);">
                            <div colspan="5" style="grid-column: 1 / -1;">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
                                <p>No attendance records found</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                records.forEach(record => {
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.innerHTML = `
                        <div>
                            <strong>${record.courseCode}: ${record.courseName}</strong>
                            <div style="color: var(--gray); font-size: 0.9rem;">
                                ${new Date(record.date).toLocaleDateString('en-US', { 
                                    weekday: 'short', 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                })}
                            </div>
                        </div>
                        <div>${record.time}</div>
                        <div>${record.lecturer}</div>
                        <div class="status-${record.status}">
                            ${record.status === 'present' ? 'Present ✓' : 'Absent ✗'}
                        </div>
                        <div>${record.remarks}</div>
                    `;
                    tableBody.appendChild(row);
                });

                this.updateSummary(records);
            }

            updateSummary(records) {
                const totalClasses = records.length;
                const presentClasses = records.filter(r => r.status === 'present').length;
                const absentClasses = totalClasses - presentClasses;
                const attendanceRate = totalClasses > 0 ? Math.round((presentClasses / totalClasses) * 100) : 0;

                document.getElementById('totalClasses').textContent = totalClasses;
                document.getElementById('presentClasses').textContent = presentClasses;
                document.getElementById('absentClasses').textContent = absentClasses;
                document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
            }

            applyFilters() {
                const courseFilter = document.getElementById('courseFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const monthFilter = document.getElementById('monthFilter').value;

                let filteredRecords = this.records;

                // Apply course filter
                if (courseFilter !== 'all') {
                    filteredRecords = filteredRecords.filter(record => record.courseId === parseInt(courseFilter));
                }

                // Apply status filter
                if (statusFilter !== 'all') {
                    filteredRecords = filteredRecords.filter(record => record.status === statusFilter);
                }

                // Apply month filter
                if (monthFilter !== 'all') {
                    const targetMonth = parseInt(monthFilter);
                    filteredRecords = filteredRecords.filter(record => new Date(record.date).getMonth() === targetMonth);
                }

                this.renderHistory(filteredRecords);
            }

            resetFilters() {
                document.getElementById('courseFilter').value = 'all';
                document.getElementById('statusFilter').value = 'all';
                document.getElementById('monthFilter').value = 'all';
                this.renderHistory();
            }

            setupEventListeners() {
                // Logout button
                document.querySelector('.logout-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });
            }

            logout() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = '../index.html';
            }
        }

        function applyFilters() {
            const history = new AttendanceHistory();
            history.applyFilters();
        }

        function resetFilters() {
            const history = new AttendanceHistory();
            history.resetFilters();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #0f766e;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                max-width: 300px;
            `;
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize history
        document.addEventListener('DOMContentLoaded', () => {
            new AttendanceHistory();
        });
    </script>
</body>
</html>