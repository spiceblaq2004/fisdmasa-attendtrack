<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturer Dashboard - FISDMASA AttendTrack</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard {
            padding: 100px 20px 50px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .lecturer-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .action-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-decoration: none;
            color: var(--dark);
            transition: transform 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .action-card i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .today-sessions {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .session-item:last-child {
            border-bottom: none;
        }
        
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .qr-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .qr-display {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-fire-extinguisher"></i>
                <span>FISDMASA AttendTrack</span>
            </div>
            <div class="nav-links">
                <a href="../index.html">Home</a>
                <span id="userWelcome">Welcome, Lecturer!</span>
                <a href="../index.html" class="login-btn logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard">
        <div class="dashboard-header">
            <div class="welcome-message">
                <h1>Lecturer Dashboard</h1>
                <p>Manage your courses and track student attendance</p>
            </div>
        </div>

        <div class="lecturer-actions">
            <div class="action-card" id="generateQRBtn">
                <i class="fas fa-qrcode"></i>
                <h3>Generate QR Code</h3>
                <p>Create attendance session</p>
            </div>
            
            <div class="action-card" onclick="showNotification('Student management coming soon!')">
                <i class="fas fa-users"></i>
                <h3>Manage Students</h3>
                <p>View class lists</p>
            </div>
            
            <div class="action-card" onclick="showNotification('Reports coming soon!')">
                <i class="fas fa-chart-bar"></i>
                <h3>View Reports</h3>
                <p>Attendance analytics</p>
            </div>
            
            <div class="action-card" onclick="showNotification('Export feature coming soon!')">
                <i class="fas fa-download"></i>
                <h3>Export Data</h3>
                <p>Download reports</p>
            </div>
        </div>

        <div class="today-sessions">
            <h2 style="margin-bottom: 20px;">Today's Sessions</h2>
            
            <div class="session-item">
                <div>
                    <h4>FSDM 301: Fire Dynamics</h4>
                    <p>8:00 AM - 10:00 AM • Lecture Hall A</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="generateQRCode(1)">Start Attendance</button>
                </div>
            </div>
            
            <div class="session-item">
                <div>
                    <h4>FSDM 303: Disaster Management</h4>
                    <p>2:00 PM - 4:00 PM • Lab 3</p>
                </div>
                <div>
                    <button class="btn" onclick="showNotification('Session report coming soon!')">View Report</button>
                </div>
            </div>
        </div>

        <h2>Your Courses</h2>
        <div class="courses-grid">
            <div class="course-card">
                <h3>FSDM 301: Fire Dynamics</h3>
                <p>45 Students • Mon, Wed 8:00 AM</p>
                <div class="attendance-bar">
                    <div class="attendance-progress" style="width: 88%; background: #10b981;"></div>
                </div>
                <p>Class Average: 88% • 40/45 students present</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="generateQRCode(1)">Start Attendance</button>
                    <button class="btn" onclick="showNotification('Course reports coming soon!')">View Report</button>
                </div>
            </div>
            
            <div class="course-card">
                <h3>FSDM 303: Disaster Management</h3>
                <p>38 Students • Tue, Thu 10:00 AM</p>
                <div class="attendance-bar">
                    <div class="attendance-progress" style="width: 75%; background: #f59e0b;"></div>
                </div>
                <p>Class Average: 75% • 28/38 students present</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="generateQRCode(2)">Start Attendance</button>
                    <button class="btn" onclick="showNotification('Course reports coming soon!')">View Report</button>
                </div>
            </div>

            <div class="course-card">
                <h3>FSDM 305: Safety Engineering</h3>
                <p>32 Students • Fri 2:00 PM</p>
                <div class="attendance-bar">
                    <div class="attendance-progress" style="width: 92%; background: #10b981;"></div>
                </div>
                <p>Class Average: 92% • 30/32 students present</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="generateQRCode(3)">Start Attendance</button>
                    <button class="btn" onclick="showNotification('Course reports coming soon!')">View Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-modal-content">
            <h2>Attendance QR Code</h2>
            <p>Students should scan this code to mark attendance</p>
            
            <div class="qr-display" id="qrCodeDisplay">
                ┌──────────────────┐
                │  FISDMASA QR     │
                │                  │
                │  ██████████████  │
                │  ██          ██  │
                │  ██  ██████  ██  │
                │  ██  ██████  ██  │
                │  ██          ██  │
                │  ██████████████  │
                │                  │
                │  Loading...      │
                └──────────────────┘
            </div>
            
            <div style="margin: 20px 0;">
                <strong>Course:</strong> <span id="qrCourseName">Loading...</span><br>
                <strong>Code:</strong> <span id="qrCodeText">Loading...</span><br>
                <strong>Valid for:</strong> 15 minutes
            </div>
            
            <button class="btn btn-primary" onclick="closeQRModal()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <script>
        // Mock Backend for Lecturer
        class LecturerBackend {
            constructor() {
                this.courses = [
                    {
                        id: 1,
                        courseCode: "FSDM 301",
                        courseName: "Fire Dynamics",
                        lecturer: 2,
                        students: [1],
                        schedule: "Mon, Wed 8:00 AM"
                    },
                    {
                        id: 2, 
                        courseCode: "FSDM 303",
                        courseName: "Disaster Management",
                        lecturer: 2,
                        students: [1],
                        schedule: "Tue, Thu 10:00 AM"
                    },
                    {
                        id: 3,
                        courseCode: "FSDM 305", 
                        courseName: "Safety Engineering",
                        lecturer: 2,
                        students: [1],
                        schedule: "Fri 2:00 PM"
                    }
                ];
                this.sessions = [];
                this.sessionCounter = 100;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            validateToken(token) {
                try {
                    const userData = JSON.parse(atob(token));
                    if (userData.exp < Date.now()) {
                        throw new Error('Token expired');
                    }
                    return userData;
                } catch (error) {
                    throw { error: 'Invalid token' };
                }
            }

            async generateQRSession(token, courseId) {
                await this.delay(500);
                
                const userData = this.validateToken(token);
                if (userData.role !== 'lecturer') {
                    throw { error: 'Only lecturers can create sessions' };
                }

                const session = {
                    id: this.sessionCounter++,
                    courseId: parseInt(courseId),
                    lecturer: userData.userId,
                    date: new Date(),
                    qrCode: `FISDMA-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    isActive: true,
                    duration: 15,
                    createdAt: new Date()
                };

                this.sessions.push(session);

                const course = this.courses.find(c => c.id === session.courseId);

                return {
                    session: session,
                    course: course,
                    qrImage: this.generateQRImage(session.qrCode),
                    message: 'Attendance session created successfully'
                };
            }

            generateQRImage(qrCode) {
                return `
┌──────────────────┐
│  FISDMASA QR     │
│                  │
│  ██████████████  │
│  ██          ██  │
│  ██  ██████  ██  │
│  ██  ██████  ██  │
│  ██          ██  │
│  ██████████████  │
│                  │
│  ${qrCode.substr(0, 8)}  │
└──────────────────┘
                `;
            }
        }

        // Lecturer Dashboard functionality
        class LecturerDashboard {
            constructor() {
                this.token = localStorage.getItem('authToken');
                this.user = JSON.parse(localStorage.getItem('user') || '{}');
                this.backend = new LecturerBackend();
                this.init();
            }

            async init() {
                if (!this.token) {
                    window.location.href = 'login.html';
                    return;
                }

                if (this.user.role !== 'lecturer') {
                    this.showError('Access denied. Lecturer account required.');
                    setTimeout(() => {
                        this.logout();
                    }, 3000);
                    return;
                }

                this.updateWelcomeMessage();
                this.setupEventListeners();
            }

            updateWelcomeMessage() {
                document.getElementById('userWelcome').textContent = `Welcome, ${this.user.name.split(' ')[0]}!`;
            }

            setupEventListeners() {
                // Generate QR button
                document.getElementById('generateQRBtn').addEventListener('click', () => {
                    this.showCourseSelection();
                });

                // Logout button
                document.querySelector('.logout-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });
            }

            showCourseSelection() {
                const courseList = this.backend.courses.map(course => 
                    `<option value="${course.id}">${course.courseCode}: ${course.courseName}</option>`
                ).join('');

                const selection = prompt(
                    'Select a course to generate QR code:\n\n' +
                    this.backend.courses.map(course => 
                        `${course.id}. ${course.courseCode}: ${course.courseName}`
                    ).join('\n') +
                    '\n\nEnter course number:'
                );

                if (selection && ['1','2','3'].includes(selection)) {
                    this.generateQRCode(parseInt(selection));
                }
            }

            async generateQRCode(courseId) {
                try {
                    const result = await this.backend.generateQRSession(this.token, courseId);
                    this.showQRModal(result);
                } catch (error) {
                    this.showError(error.error || 'Failed to generate QR code');
                }
            }

            showQRModal(result) {
                document.getElementById('qrCourseName').textContent = 
                    `${result.course.courseCode}: ${result.course.courseName}`;
                document.getElementById('qrCodeText').textContent = result.session.qrCode;
                document.getElementById('qrCodeDisplay').textContent = result.qrImage;
                document.getElementById('qrModal').style.display = 'flex';
            }

            logout() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = '../index.html';
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: #dc2626;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                    max-width: 300px;
                `;
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        }

        // Global functions for button clicks
        function generateQRCode(courseId) {
            const dashboard = new LecturerDashboard();
            dashboard.generateQRCode(courseId);
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #0f766e;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                max-width: 300px;
            `;
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Close modal when clicking outside
        document.getElementById('qrModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQRModal();
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new LecturerDashboard();
        });
    </script>
</body>
</html>